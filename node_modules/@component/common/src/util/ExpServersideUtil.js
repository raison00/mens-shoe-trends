module.exports = (function () {
  const queryString = function (search) {
    const queryStr = search;
    const queryArr = queryStr.replace('?', '').split('&');
    const queryParams = {};

    for (let q = 0, qArrLength = queryArr.length; q < qArrLength; q++) {
      const qArr = queryArr[q].split('=');
      queryParams[qArr[0]] = qArr[1];
    }

    return queryParams;
  };

  function getServersideRecipeIds(req) {
    const url = req.originalUrl;
    let parsedObject = {};
    const search = url.substr(url.indexOf('?'));
    const requestParams = queryString(search);

    if (typeof requestParams.EFCKEY !== 'undefined') {
      try {
        parsedObject = JSON.parse(decodeURIComponent(requestParams.EFCKEY));
      } catch (e) {
        console.error('Failed getting EFCKEY: ', e);
      }
    }

    if (typeof req.headers !== 'undefined' && typeof req.headers['x-macys-experiments'] !== 'undefined') {
      try {
        parsedObject = JSON.parse(decodeURIComponent(req.headers['x-macys-experiments']));
      } catch (e) {
        console.error('Failed getting X-Macys-Experiments: ', e);
      }
    }

    if (Array.isArray(parsedObject.EXPERIMENT)) {
      return parsedObject.EXPERIMENT;
    }

    return [];
  }

  return {
    getServersideRecipeIds,
  };
}());
