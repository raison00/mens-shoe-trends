import _ from 'underscore';
import ProductImage from './ProductImage';

const SWATCH_WIDTH = 32;
const JUMBO_SWATCH_WIDTH = 64;
const MAX_SWATCHES = 16;
const IMG_WIDTH = 245;

function calculateOffset(swatchCount, swatchWidth, idx) {
  return parseInt(swatchCount * swatchWidth, 10) - ((idx % MAX_SWATCHES) * swatchWidth);
}

function buildColorSwatchSprite(data) {
  const swatches = data.colors.colorMap;
  const swatchCount = swatches.length;
  const urlTemplate = `${data.colors.urlTemplate.swatch}?&$b=MCY/swatches/&layer=0&size=`;
  const countStr = `&cropN=0,0,${swatchCount},1`;

  let swatchUrl = `${urlTemplate}${parseInt(swatchCount * SWATCH_WIDTH, 10)},${SWATCH_WIDTH}${countStr}`;
  let jumboSwatchUrl = `${urlTemplate}${parseInt(swatchCount * JUMBO_SWATCH_WIDTH, 10)},${JUMBO_SWATCH_WIDTH}${countStr}`;

  let swatchParams = '';
  let jumboSwatchParams = '';

  _.each(swatches, (val, idx) => {
    if (val && val.swatchImage && val.swatchImage.filePath) {
      const pre = `&src=is{$b$${val.swatchImage.filePath}}&anchor=0,0&layer=${idx + 1}&size=`;
      const post = `&posN=${(1 / swatchCount) * (idx + 1)},0`;

      swatchParams += `${pre}${SWATCH_WIDTH},${SWATCH_WIDTH}${post}`;
      jumboSwatchParams += `${pre}${JUMBO_SWATCH_WIDTH},${JUMBO_SWATCH_WIDTH}${post}`;
    }
  });

  const opts = '&op_sharpen=1&fmt=jpeg&qlt=90,0&hei=';
  swatchUrl = `${swatchUrl + swatchParams}${opts}${SWATCH_WIDTH}`;
  jumboSwatchUrl = `${jumboSwatchUrl + jumboSwatchParams}${opts}${JUMBO_SWATCH_WIDTH}`;
  return {
    swatchUrl,
    jumboSwatchUrl,
  };
}

function buildColorSwatchData(data, detail) {
  const swatches = data.colors.colorMap;
  const swatchCount = swatches.length;
  const { swatchUrl, jumboSwatchUrl } = buildColorSwatchSprite(data);
  const selectedSwatch = data.colors.selectedColor;
  const { flags } = detail;

  _.each(swatches, (val, idx) => {
    swatches[idx].colorSwatchSprite = swatchUrl;
    swatches[idx].offset = calculateOffset(swatchCount, SWATCH_WIDTH, idx);
    if (val && val.imagery && val.imagery.primaryImage && val.imagery.primaryImage.filePath) {
      /*
      * Handling the error as ProductImage.buildSimpleUrl doesn't exist.
      */
      try {
        swatches[idx].preview = ProductImage.buildSimpleUrl(data.colors.urlTemplate.product, val.imagery.primaryImage.filePath, IMG_WIDTH);
      } catch (e) {
        //
      }
      if (val.imagery.primaryImage.showJumboSwatch || (flags.masterProduct && !flags.hasColors)) {
        swatches[idx].jumboSwatch = jumboSwatchUrl;
        swatches[idx].jumboSwatchOffset = calculateOffset(swatchCount, JUMBO_SWATCH_WIDTH, idx);
      }
    }
    if (selectedSwatch && selectedSwatch.id && val.id && selectedSwatch.id === val.id) {
      swatches[idx].swatchSelected = true;
    }
  });
  return swatches;
}

export default {
  buildColorSwatchData,
};
